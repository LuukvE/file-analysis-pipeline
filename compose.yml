services:
  aws:
    build:
      context: ./aws
    environment:
      - DEBUG=1
      - ENFORCE_IAM=1
      - SERVICES=iam,s3,dynamodb
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./aws:/etc/localstack/init/ready.d"
      - ./:/monorepo
    networks:
      - bridge-network
    ports:
      - "4566:4566"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "awslocal dynamodbstreams list-streams --table-name jobs --region eu-west-1 | jq -e '.Streams | length > 0' > /dev/null 2>&1",
        ]
      interval: 5s
      timeout: 10s
      retries: 10

  server:
    build:
      context: .
      dockerfile: ./server/Dockerfile
    volumes:
      - ./server/:/app/server/
      - ./shared/:/app/shared/
    networks:
      - bridge-network
    environment:
      - PORT=8080
    ports:
      - "8080:8080"
    depends_on:
      aws:
        condition: service_healthy

  processor:
    build:
      context: .
      dockerfile: ./processor/Dockerfile
    volumes:
      - ./processor/:/app/processor/
      - ./shared/:/app/shared/
    networks:
      - bridge-network
    depends_on:
      aws:
        condition: service_healthy

  engine:
    build:
      context: ./engine
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - bridge-network
    expose:
      - "8000"

networks:
  bridge-network:
    driver: bridge
